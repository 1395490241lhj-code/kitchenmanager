(function(){if(!('serviceWorker'in navigator))return;const VERSION='v16';const KEY='km-sw-'+VERSION;if(location.hash.includes('sw=off')){navigator.serviceWorker.getRegistrations().then(r=>r.forEach(x=>x.unregister()));if(window.caches&&caches.keys)caches.keys().then(k=>k.forEach(x=>caches.delete(x)));return;}navigator.serviceWorker.getRegistrations().then(async regs=>{for(const r of regs){const url=(r.active&&r.active.scriptURL)||'';if(!/sw\.v16\.js/.test(url)){try{await r.unregister()}catch(_){}}}try{const reg=await navigator.serviceWorker.register('./sw.v16.js?v='+VERSION,{scope:'./'});if(!localStorage.getItem(KEY)){let re=false;const li=w=>{if(!w)return;w.addEventListener('statechange',()=>{if(w.state==='activated'&&!re){re=true;localStorage.setItem(KEY,'1');location.reload()}})};if(reg.installing)li(reg.installing);reg.addEventListener('updatefound',()=>li(reg.installing));setTimeout(()=>localStorage.setItem(KEY,'1'),4000)}}catch(e){}})();